// Prisma schema defining core WMS domain entities with multi-tenant support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BatchStatus {
  NORMAL
  BLOCKED
  RECALL
  UNDER_INVESTIGATION
}

enum CycleCountStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AdjustmentType {
  GAIN
  LOSS
  CORRECTION
}

enum StockStatus {
  AVAILABLE
  RESERVED
  PICKING
  IN_TRANSIT_INTERNAL
  QUARANTINE
  SCRAP
  BLOCKED
}

enum InboundReceiptStatus {
  DRAFT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum MovementType {
  INBOUND_RECEIPT
  INTERNAL_TRANSFER
  ADJUSTMENT
  OUTBOUND_SHIPMENT
}

enum MovementStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum HandlingUnitType {
  BOX
  PALLET
  PARCEL
  CONTAINER
  OTHER
}

enum ShipmentStatus {
  PLANNED
  LOADING
  DISPATCHED
  CANCELLED
}

enum OutboundOrderStatus {
  DRAFT
  RELEASED
  PARTIALLY_ALLOCATED
  FULLY_ALLOCATED
  PICKING
  PARTIALLY_PICKED
  PICKED
  CANCELLED
}

enum PickingMethodType {
  ORDER
  WAVE
  BATCH
  ZONE
}

enum ZoneType {
  RECEIVING
  PICKING
  RESERVE
  QUARANTINE
  SHIPPING
  RETURNS
  SCRAP
  OTHER
}

enum PickingTaskStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  plan      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  warehouses            Warehouse[]
  products              Product[]
  batches               Batch[]
  inventories           Inventory[]
  locations             Location[]
  inboundReceipts       InboundReceipt[]
  inboundReceiptLines   InboundReceiptLine[]
  outboundOrders        OutboundOrder[]
  outboundOrderLines    OutboundOrderLine[]
  pickingTasks          PickingTask[]
  pickingTaskLines      PickingTaskLine[]
  cycleCountTasks       CycleCountTask[]
  cycleCountLines       CycleCountLine[]
  adjustments           InventoryAdjustment[]
  movementHeaders       MovementHeader[]
  movementLines         MovementLine[]
  handlingUnits         HandlingUnit[]
  handlingUnitLines     HandlingUnitLine[]
  shipments             Shipment[]
  shipmentHandlingUnits ShipmentHandlingUnit[]
  tenantConfigs         TenantConfig[]
  pickingMethodConfigs  PickingMethodConfig[]
  warehouseZoneConfigs  WarehouseZoneConfig[]
  inventoryPolicies     InventoryPolicy[]
  outboundRules         OutboundRule[]
}

model User {
  id           String   @id @default(uuid())
  email        String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?
  updatedBy    String?
  tenantId     String

  roleId String?
  role   Role?   @relation(fields: [roleId], references: [id])
  tenant Tenant  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id        String  @id @default(uuid())
  name      String  @unique
  users     User[]
  createdBy String?
  updatedBy String?
}

model Warehouse {
  id                   String                @id @default(uuid())
  tenantId             String
  code                 String
  name                 String
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  createdBy            String?
  updatedBy            String?
  locations            Location[]
  inboundReceipts      InboundReceipt[]
  movementHeaders      MovementHeader[]
  cycleCountTasks      CycleCountTask[]
  inventoryAdjustments InventoryAdjustment[]
  outboundOrders       OutboundOrder[]
  pickingTasks         PickingTask[]
  handlingUnits        HandlingUnit[]
  shipments            Shipment[]
  pickingMethodConfigs PickingMethodConfig[]
  warehouseZoneConfigs WarehouseZoneConfig[]
  inventoryPolicies    InventoryPolicy[]
  outboundRules        OutboundRule[]
  tenant               Tenant                @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
}

model Location {
  id          String   @id @default(uuid())
  tenantId    String
  warehouseId String
  code        String
  description String?
  zone        String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  warehouse            Warehouse             @relation(fields: [warehouseId], references: [id])
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  inventory            Inventory[]
  movementLinesFrom    MovementLine[]        @relation("MovementFrom")
  movementLinesTo      MovementLine[]        @relation("MovementTo")
  cycleCountLines      CycleCountLine[]
  inventoryAdjustments InventoryAdjustment[]
  pickingTaskLinesFrom PickingTaskLine[]     @relation("PickingTaskFromLocation")

  @@unique([warehouseId, code])
  @@index([tenantId])
  @@index([code])
}

model Product {
  id                 String   @id @default(uuid())
  tenantId           String
  sku                String
  name               String
  requiresBatch      Boolean  @default(false)
  requiresExpiryDate Boolean  @default(false)
  defaultUom         String
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String?
  updatedBy          String?

  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  batches              Batch[]
  inventory            Inventory[]
  inboundReceiptLines  InboundReceiptLine[]
  movementLines        MovementLine[]
  cycleCountLines      CycleCountLine[]
  inventoryAdjustments InventoryAdjustment[]
  outboundOrderLines   OutboundOrderLine[]
  pickingTaskLines     PickingTaskLine[]     @relation("PickingTaskLineProduct")
  handlingUnitLines    HandlingUnitLine[]
  inventoryPolicies    InventoryPolicy[]

  @@unique([tenantId, sku])
  @@index([tenantId])
}

model Batch {
  id         String      @id @default(uuid())
  tenantId   String
  productId  String
  batchCode  String
  expiryDate DateTime?
  status     BatchStatus @default(NORMAL)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  createdBy  String?
  updatedBy  String?

  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  product              Product               @relation(fields: [productId], references: [id])
  inventory            Inventory[]
  movementLines        MovementLine[]
  inboundReceiptLines  InboundReceiptLine[]
  cycleCountLines      CycleCountLine[]
  inventoryAdjustments InventoryAdjustment[]
  pickingTaskLines     PickingTaskLine[]     @relation("PickingTaskLineBatch")
  handlingUnitLines    HandlingUnitLine[]

  @@index([productId, batchCode])
  @@index([tenantId])
}

model Inventory {
  id          String      @id @default(uuid())
  tenantId    String
  productId   String
  batchId     String?
  locationId  String
  quantity    Decimal     @db.Decimal(20, 4)
  uom         String
  stockStatus StockStatus @default(AVAILABLE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String?
  updatedBy   String?

  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  product              Product               @relation(fields: [productId], references: [id])
  batch                Batch?                @relation(fields: [batchId], references: [id])
  location             Location              @relation(fields: [locationId], references: [id])
  inventoryAdjustments InventoryAdjustment[]

  @@index([productId, batchId, locationId])
  @@index([tenantId])
}

model InboundReceipt {
  id          String               @id @default(uuid())
  tenantId    String
  warehouseId String
  externalRef String?
  status      InboundReceiptStatus
  receivedAt  DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdBy   String?
  updatedBy   String?

  tenant    Tenant               @relation(fields: [tenantId], references: [id])
  warehouse Warehouse            @relation(fields: [warehouseId], references: [id])
  lines     InboundReceiptLine[]

  @@index([warehouseId, status])
  @@index([tenantId])
}

model InboundReceiptLine {
  id                    String    @id @default(uuid())
  tenantId              String
  inboundReceiptId      String
  productId             String
  expectedQty           Decimal   @db.Decimal(20, 4)
  receivedQty           Decimal   @default(0) @db.Decimal(20, 4)
  uom                   String
  batchCode             String?
  expiryDate            DateTime?
  sourceDocumentLineRef String?
  batchId               String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  inboundReceipt InboundReceipt @relation(fields: [inboundReceiptId], references: [id])
  product        Product        @relation(fields: [productId], references: [id])
  batch          Batch?         @relation(fields: [batchId], references: [id])

  @@index([inboundReceiptId, productId])
  @@index([tenantId])
}

model MovementHeader {
  id           String         @id @default(uuid())
  tenantId     String
  movementType MovementType
  warehouseId  String
  reference    String?
  status       MovementStatus
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    String?

  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  warehouse            Warehouse             @relation(fields: [warehouseId], references: [id])
  lines                MovementLine[]
  inventoryAdjustments InventoryAdjustment[]

  @@index([movementType, warehouseId, status])
  @@index([tenantId])
}

model MovementLine {
  id               String    @id @default(uuid())
  tenantId         String
  movementHeaderId String
  productId        String
  batchId          String?
  fromLocationId   String?
  toLocationId     String?
  quantity         Decimal   @db.Decimal(20, 4)
  uom              String
  batchCode        String?
  expiryDate       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  movementHeader MovementHeader @relation(fields: [movementHeaderId], references: [id])
  product        Product        @relation(fields: [productId], references: [id])
  batch          Batch?         @relation(fields: [batchId], references: [id])
  fromLocation   Location?      @relation("MovementFrom", fields: [fromLocationId], references: [id])
  toLocation     Location?      @relation("MovementTo", fields: [toLocationId], references: [id])

  @@index([movementHeaderId, productId, batchId])
  @@index([tenantId])
}

model CycleCountTask {
  id          String           @id @default(uuid())
  tenantId    String
  warehouseId String
  description String?
  status      CycleCountStatus
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   String?
  startedAt   DateTime?
  completedAt DateTime?

  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  warehouse Warehouse        @relation(fields: [warehouseId], references: [id])
  lines     CycleCountLine[]

  @@index([warehouseId, status])
  @@index([tenantId])
}

model CycleCountLine {
  id               String    @id @default(uuid())
  tenantId         String
  cycleCountTaskId String
  productId        String
  batchId          String?
  locationId       String
  uom              String
  expectedQty      Decimal   @db.Decimal(20, 4)
  countedQty       Decimal?  @db.Decimal(20, 4)
  differenceQty    Decimal?  @db.Decimal(20, 4)
  countedAt        DateTime?
  countedBy        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  cycleCountTask CycleCountTask @relation(fields: [cycleCountTaskId], references: [id])
  product        Product        @relation(fields: [productId], references: [id])
  batch          Batch?         @relation(fields: [batchId], references: [id])
  location       Location       @relation(fields: [locationId], references: [id])

  @@index([cycleCountTaskId, productId, locationId])
  @@index([tenantId])
}

model InventoryAdjustment {
  id               String         @id @default(uuid())
  tenantId         String
  warehouseId      String
  productId        String
  batchId          String?
  locationId       String
  inventoryId      String?
  movementHeaderId String?
  adjustmentType   AdjustmentType
  previousQty      Decimal        @db.Decimal(20, 4)
  newQty           Decimal        @db.Decimal(20, 4)
  differenceQty    Decimal        @db.Decimal(20, 4)
  reason           String
  reference        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        String?

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])
  product        Product         @relation(fields: [productId], references: [id])
  batch          Batch?          @relation(fields: [batchId], references: [id])
  location       Location        @relation(fields: [locationId], references: [id])
  inventory      Inventory?      @relation(fields: [inventoryId], references: [id])
  movementHeader MovementHeader? @relation(fields: [movementHeaderId], references: [id])

  @@index([warehouseId, productId, locationId, createdAt])
  @@index([tenantId])
}

model OutboundOrder {
  id                String              @id @default(uuid())
  tenantId          String
  warehouseId       String
  externalRef       String?
  customerRef       String?
  status            OutboundOrderStatus
  requestedShipDate DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdBy         String?

  tenant                Tenant                 @relation(fields: [tenantId], references: [id])
  warehouse             Warehouse              @relation(fields: [warehouseId], references: [id])
  lines                 OutboundOrderLine[]
  pickingTasks          PickingTask[]
  handlingUnitLines     HandlingUnitLine[]
  shipmentHandlingUnits ShipmentHandlingUnit[]

  @@index([warehouseId, status, requestedShipDate])
  @@index([tenantId])
}

model OutboundOrderLine {
  id              String   @id @default(uuid())
  tenantId        String
  outboundOrderId String
  productId       String
  requestedQty    Decimal  @db.Decimal(20, 4)
  allocatedQty    Decimal  @default(0) @db.Decimal(20, 4)
  pickedQty       Decimal  @default(0) @db.Decimal(20, 4)
  uom             String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  outboundOrder     OutboundOrder      @relation(fields: [outboundOrderId], references: [id])
  product           Product            @relation(fields: [productId], references: [id])
  pickingTaskLines  PickingTaskLine[]  @relation("OutboundLinePicking")
  handlingUnitLines HandlingUnitLine[]

  @@index([outboundOrderId, productId])
  @@index([tenantId])
}

model PickingTask {
  id              String            @id @default(uuid())
  tenantId        String
  warehouseId     String
  outboundOrderId String
  status          PickingTaskStatus
  pickerId        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  startedAt       DateTime?
  completedAt     DateTime?

  tenant        Tenant            @relation(fields: [tenantId], references: [id])
  warehouse     Warehouse         @relation(fields: [warehouseId], references: [id])
  outboundOrder OutboundOrder     @relation(fields: [outboundOrderId], references: [id])
  lines         PickingTaskLine[]

  @@index([warehouseId, outboundOrderId, status])
  @@index([tenantId])
}

model PickingTaskLine {
  id                  String   @id @default(uuid())
  tenantId            String
  pickingTaskId       String
  outboundOrderLineId String
  productId           String
  batchId             String?
  fromLocationId      String
  quantityToPick      Decimal  @db.Decimal(20, 4)
  quantityPicked      Decimal  @default(0) @db.Decimal(20, 4)
  uom                 String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  pickingTask       PickingTask       @relation(fields: [pickingTaskId], references: [id])
  outboundOrderLine OutboundOrderLine @relation("OutboundLinePicking", fields: [outboundOrderLineId], references: [id])
  product           Product           @relation("PickingTaskLineProduct", fields: [productId], references: [id])
  batch             Batch?            @relation("PickingTaskLineBatch", fields: [batchId], references: [id])
  fromLocation      Location          @relation("PickingTaskFromLocation", fields: [fromLocationId], references: [id])

  @@index([pickingTaskId, productId, batchId, fromLocationId])
  @@index([tenantId])
}

model HandlingUnit {
  id               String           @id @default(uuid())
  tenantId         String
  warehouseId      String
  handlingUnitType HandlingUnitType
  code             String
  externalLabel    String?
  grossWeight      Decimal?         @db.Decimal(20, 4)
  volume           Decimal?         @db.Decimal(20, 4)
  length           Decimal?         @db.Decimal(20, 4)
  width            Decimal?         @db.Decimal(20, 4)
  height           Decimal?         @db.Decimal(20, 4)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?

  tenant    Tenant                 @relation(fields: [tenantId], references: [id])
  warehouse Warehouse              @relation(fields: [warehouseId], references: [id])
  lines     HandlingUnitLine[]
  shipments ShipmentHandlingUnit[]

  @@index([warehouseId, code])
  @@index([tenantId])
}

model HandlingUnitLine {
  id                  String   @id @default(uuid())
  tenantId            String
  handlingUnitId      String
  outboundOrderId     String
  outboundOrderLineId String
  productId           String
  batchId             String?
  quantity            Decimal  @db.Decimal(20, 4)
  uom                 String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  handlingUnit      HandlingUnit      @relation(fields: [handlingUnitId], references: [id])
  outboundOrder     OutboundOrder     @relation(fields: [outboundOrderId], references: [id])
  outboundOrderLine OutboundOrderLine @relation(fields: [outboundOrderLineId], references: [id])
  product           Product           @relation(fields: [productId], references: [id])
  batch             Batch?            @relation(fields: [batchId], references: [id])

  @@index([handlingUnitId, outboundOrderId, productId, batchId])
  @@index([tenantId])
}

model Shipment {
  id                 String         @id @default(uuid())
  tenantId           String
  warehouseId        String
  carrierRef         String?
  vehicleRef         String?
  routeRef           String?
  status             ShipmentStatus
  scheduledDeparture DateTime?
  actualDeparture    DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  createdBy          String?

  tenant                Tenant                 @relation(fields: [tenantId], references: [id])
  warehouse             Warehouse              @relation(fields: [warehouseId], references: [id])
  shipmentHandlingUnits ShipmentHandlingUnit[]

  @@index([warehouseId, status, scheduledDeparture])
  @@index([tenantId])
}

model ShipmentHandlingUnit {
  id              String   @id @default(uuid())
  tenantId        String
  shipmentId      String
  handlingUnitId  String
  outboundOrderId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  shipment      Shipment      @relation(fields: [shipmentId], references: [id])
  handlingUnit  HandlingUnit  @relation(fields: [handlingUnitId], references: [id])
  outboundOrder OutboundOrder @relation(fields: [outboundOrderId], references: [id])

  @@index([shipmentId, handlingUnitId, outboundOrderId])
  @@index([tenantId])
}

model TenantConfig {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  defaultUom                String?
  defaultStockStatus        String?
  defaultBatchPolicy        String?
  allowNegativeStock        Boolean @default(false)
  enableCycleCounting       Boolean @default(true)
  cycleCountDefaultFreqDays Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model PickingMethodConfig {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  method    PickingMethodType
  isDefault Boolean           @default(false)
  isActive  Boolean           @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, warehouseId])
}

model WarehouseZoneConfig {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  code     String
  name     String
  zoneType ZoneType
  isActive Boolean  @default(true)

  allowInbound Boolean @default(false)
  allowPicking Boolean @default(false)
  allowStorage Boolean @default(false)
  allowReturns Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, warehouseId])
}

model InventoryPolicy {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  maxOverReceiptPct    Float?
  maxUnderReceiptPct   Float?
  cycleCountFreqDays   Int?
  maxInventoryVariance Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, warehouseId])
  @@index([tenantId, productId])
}

model OutboundRule {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  allowPartialShipments   Boolean            @default(true)
  enforceFullAllocation   Boolean            @default(false)
  defaultPickingMethod    PickingMethodType?
  defaultShipmentStrategy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, warehouseId])
}
